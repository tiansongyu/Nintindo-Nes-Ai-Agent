# NES 内存与数据存储参考文档

## 1. 概述

NES (Nintendo Entertainment System) 使用 **MOS 6502 CPU**（变体2A03），这是一个8位处理器。
理解NES的内存结构对于进行游戏内存hack和AI训练数据获取至关重要。

## 2. 数据存储格式

### 2.1 字节序（Endianness）
- **6502 CPU使用小端序（Little-Endian）**
- 多字节数据的低位字节存储在较低的内存地址
- 例如：数值 `$1234` 存储为 `$34` (低地址) `$12` (高地址)

### 2.2 数据类型
NES不支持浮点运算，所有数据都是整数类型：
- **8位无符号整数（u8）**: 0-255，最常见的类型
- **8位有符号整数（i8）**: -128 到 127
- **16位值**: 由两个8位值组合，使用地址偏移计算

### 2.3 data.json 类型标记说明
| 类型标记 | 含义 | 范围 |
|---------|------|------|
| `\|u1` | 1字节无符号整数 | 0-255 |
| `\|i1` | 1字节有符号整数 | -128 to 127 |
| `<u4` | 4字节小端无符号整数 | 0-4294967295 |
| `<d4` | 4字节小端BCD编码 | - |
| `>n6` | 6字节大端BCD编码 | 用于分数显示 |

## 3. NES 内存映射 (2A03 CPU)

```
地址范围          大小       说明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
$0000-$00FF     256字节    Zero Page (快速访问)
$0100-$01FF     256字节    Stack (栈内存)
$0200-$07FF     1536字节   通用RAM
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
$0800-$1FFF     6KB        上述RAM的镜像(3次)
$2000-$2007     8字节      PPU寄存器
$2008-$3FFF     --         PPU寄存器镜像
$4000-$401F     32字节     APU和I/O寄存器
$4020-$5FFF     8KB        扩展ROM
$6000-$7FFF     8KB        SRAM (存档用)
$8000-$FFFF     32KB       PRG-ROM (游戏代码)
```

## 4. 游戏RAM分布规律

### 4.1 常见数据块分布
- **Block 0 ($00xx)**: 常用变量、游戏状态
- **Block 1 ($01xx)**: 栈/音乐音效
- **Block 2 ($02xx)**: **精灵数据（固定）**
- **Block 3-5 ($03xx-$05xx)**: 玩家/敌人属性
- **Block 6-7 ($06xx-$07xx)**: 其他游戏数据/音乐

### 4.2 行与列的组织方式
- **行（Row）**: 同类型的属性（如所有X坐标在同一行）
- **列（Column）**: 同一对象的所有属性（如玩家的HP、X、Y在同一列）

## 5. 常见游戏属性地址范围

| 属性类型 | 常见地址范围 | 查找技巧 |
|---------|-------------|---------|
| 生命数 | $0000-$00FF | 死亡时-1 |
| 玩家坐标 | $0300-$04FF | 移动时变化 |
| 分数 | $07xx, $02xxx | 得分时变化 |
| 敌人状态 | $0400-$05FF | 击败敌人时变化 |
| 关卡信息 | $07xx | 过关时变化 |

## 6. FCEUX RAM Search 使用流程

1. **打开 Tools → RAM Search**
2. **设置搜索条件**:
   - Data Size: 1 byte (大多数情况)
   - Data Type: Unsigned (常用)
3. **进行对比搜索**:
   - 值变化了 → "Not Equal To"
   - 值增加了 → "Greater Than"
   - 值减少了 → "Less Than"
4. **缩小范围**: 重复游戏操作和搜索
5. **验证地址**: 在Hex Editor中修改值确认

## 7. 参考资源

- FCEUX官方文档: https://fceux.com/web/help/
- NESdev Wiki: https://wiki.nesdev.org/
- 6502 CPU手册: MOS MCS6500 Microcomputer Family Hardware Manual

